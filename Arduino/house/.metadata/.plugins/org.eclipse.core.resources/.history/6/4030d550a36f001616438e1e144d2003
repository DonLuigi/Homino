#include <Arduino.h>
#include <Shell.h>
#include <TimedRelayComponent.h>
#include <ShutterComponent.h>
#include <HardwareSerialComponent.h>
#include <EthernetW5100Component.h>

///////////////////
//
// global
//
///////////////////
#define ENABLE_ETHERNET 1
#define ENABLE_SERIAL 1
const unsigned long reportMillis = 500;
const unsigned long windowLouvreShutterRotationMillis = 1500;

///////////////////
//
// shutter kitchen east
//
///////////////////
// relays
RelayComponent kitchenEastUpRelay (A9, LOW, true, "keUr");
RelayComponent kitchenEastDownRelay (A12, LOW, true, "keDr");

// height motion
// EEPROMValueComponent kitchenEastHeightEeprom (eepromPosition += sizeof(int32_t), sizeof(int32_t));
MotionRangeComponent kitchenEastHeightMotion (15500, 100, &kitchenEastUpRelay, &kitchenEastDownRelay, NULL, "keHm");

// shutter
ShutterComponent kitchenEast (&kitchenEastHeightMotion, NULL, NULL, NULL, "WrsKitchE", reportMillis);

///////////////////
//
// shutter kitchen south
//
///////////////////
// relays
RelayComponent kitchenSouthUpRelay (A11, LOW, true, "ksUr");
RelayComponent kitchenSouthDownRelay (A14, LOW, true, "ksDr");

// height motion
// EEPROMValueComponent kitchenSouthHeightEeprom (eepromPosition += sizeof(int32_t), sizeof(int32_t));
MotionRangeComponent kitchenSouthHeightMotion (15500, 100, &kitchenSouthUpRelay, &kitchenSouthDownRelay, NULL, "ksHm");

// shutter
ShutterComponent kitchenSouth (&kitchenSouthHeightMotion, NULL, NULL, NULL, "WrsKitchS", reportMillis);

///////////////////
//
// shutter living room west
//
///////////////////
// relays
RelayComponent livingroomWestUpRelay (A15, LOW, true, "lrwUr");
RelayComponent livingroomWestDownRelay (A13, LOW, true, "lrwDr");

// height motion
// EEPROMValueComponent livingroomWestHeightEeprom (eepromPosition += sizeof(int32_t), sizeof(int32_t));
MotionRangeComponent livingroomWestHeightMotion (22500, 100, &livingroomWestUpRelay, &livingroomWestDownRelay, NULL, "lrwHm");

// shutter
ShutterComponent livingroomWest (&livingroomWestHeightMotion, NULL, NULL, NULL, "WrsLivingW", reportMillis);

///////////////////
//
// shutter living room south
//
///////////////////
// relays
RelayComponent livingroomSouthUpRelay (15, LOW, true, "lrsUr");
RelayComponent livingroomSouthDownRelay (18, LOW, true, "lrsDr");

// height motion
MotionRangeComponent livingroomSouthHeightMotion (60000, 100, &livingroomSouthUpRelay, &livingroomSouthDownRelay, NULL, "lrsHm");

// rotation motion
MotionRangeComponent livingroomSouthRotationMotion (windowLouvreShutterRotationMillis, 100, &livingroomSouthUpRelay, &livingroomSouthDownRelay, NULL, "lrsRm");

// shutter
ShutterComponent livingroomSouth (&livingroomSouthHeightMotion, &livingroomSouthRotationMotion, NULL, NULL, "WlsLivingS", reportMillis);

///////////////////
//
// shutter dining room
//
///////////////////
// relays
RelayComponent diningRoomUpRelay (14, LOW, true, "drUr");
RelayComponent diningRoomDownRelay (19, LOW, true, "drDr");

// height motion
MotionRangeComponent diningRoomHeightMotion (60000, 100, &diningRoomUpRelay, &diningRoomDownRelay, NULL, "drHm");

// rotation motion
MotionRangeComponent diningRoomRotationMotion (windowLouvreShutterRotationMillis, 100, &diningRoomUpRelay, &diningRoomDownRelay, NULL, "drRm");

// shutter
ShutterComponent diningRoom (&diningRoomHeightMotion, &diningRoomRotationMotion, NULL, NULL, "WlsDiningS", reportMillis);

///////////////////
//
// shutter bathroom
//
///////////////////
// relays
RelayComponent bathroomUpRelay (20, LOW, true, "brUr");
RelayComponent bathroomDownRelay (A10, LOW, true, "brDr");

// height motion
MotionRangeComponent bathroomHeightMotion (15500, 100, &bathroomUpRelay, &bathroomDownRelay, NULL, "brHm");

// shutter
ShutterComponent bathroom (&bathroomHeightMotion, NULL, NULL, NULL, "WrsBath0", reportMillis);

///////////////////
//
// shutter staircase
//
///////////////////
// relays
RelayComponent staircaseUpRelay (17, LOW, true, "scUr");
RelayComponent staircaseDownRelay (16, LOW, true, "scDr");

// height motion
MotionRangeComponent staircaseHeightMotion (11000, 100, &staircaseUpRelay, &staircaseDownRelay, NULL, "scHm");

// shutter
ShutterComponent staircase (&staircaseHeightMotion, NULL, NULL, NULL, "WrsStairs", reportMillis);

///////////////////
//
// shutter bathroom 1st floor
//
///////////////////
// relays
RelayComponent bathroom1UpRelay (34, LOW, true, "br1Ur");
RelayComponent bathroom1DownRelay (36, LOW, true, "br1Dr");

// height motion
MotionRangeComponent bathroom1HeightMotion (11000, 100, &bathroom1UpRelay, &bathroom1DownRelay, NULL, "br1Hm");

// shutter
ShutterComponent bathroom1 (&bathroom1HeightMotion, NULL, NULL, NULL, "WrsBathroom1", reportMillis);

///////////////////
//
// shutter bedroom
//
///////////////////
// buttons
ButtonComponent bedroomUpButton (40, 50, "bdrUb");
ButtonComponent buttonBedroomDown (38, 50, "bdrDb");

// relays
RelayComponent bedroomUpRelay (28, LOW, true, "bdrUr");
RelayComponent bedroomDownRelay (30, LOW, true, "bdrDr");

// height motion
MotionRangeComponent bedroomHeightMotion (22500, 100, &bedroomUpRelay, &bedroomDownRelay, NULL, "bdrHm");

// shutter
ShutterComponent bedroom (&bedroomHeightMotion, NULL, &bedroomUpButton, &buttonBedroomDown, "WrsBedroom", reportMillis);

///////////////////
//
// shutter kids room east
//
///////////////////
// buttons
ButtonComponent buttonOtroskaRoletaGor (45, 50, "kreUb");
ButtonComponent buttonOtroskaRoletaDol (39, 50, "kreDb");

// relays
RelayComponent kidsRoomEastUpRelay (37, LOW, true, "kreUr");
RelayComponent kidsRoomEastDownRelay (35, LOW, true, "kreDr");

// height motion
MotionRangeComponent kidsRoomEastHeightMotion (22500, 100, &kidsRoomEastUpRelay, &kidsRoomEastDownRelay, NULL, "kreHm");

// shutter
ShutterComponent kidsRoomEast (&kidsRoomEastHeightMotion, NULL, &buttonOtroskaRoletaGor, &buttonOtroskaRoletaDol, "WrsKids", reportMillis);

///////////////////
//
// shutter kids room south
//
///////////////////
// buttons
ButtonComponent buttonKidsRoomSouthUp (43, 50, "krsUb");
ButtonComponent buttonKidsRoomSouthDown (41, 50, "krsDb");

// relays
RelayComponent kidsRoomSouthUpRelay (24, LOW, true, "krsUr");
RelayComponent kidsRoomSouthDownRelay (22, LOW, true, "krsDr");

// height motion
MotionRangeComponent kidsRoomSouthHeightMotion (60000, 100, &kidsRoomSouthUpRelay, &kidsRoomSouthDownRelay, NULL, "krsHm");

// rotation motion
MotionRangeComponent kidsRoomSouthRotationMotion (windowLouvreShutterRotationMillis, 100, &kidsRoomSouthUpRelay, &kidsRoomSouthDownRelay, NULL, "krsRm");

// shutter
ShutterComponent kidsRoomSouth (&kidsRoomSouthHeightMotion, &kidsRoomSouthRotationMotion, &buttonKidsRoomSouthUp, &buttonKidsRoomSouthDown, "WlsKids", reportMillis);

///////////////////
//
// shutter gallery
//
///////////////////
// buttons
ButtonComponent buttonGalleryUp (44, 50, "galUb");
ButtonComponent buttonGalleryDown (42, 50, "galDb");

// relays
RelayComponent galleryUpRelay (26, LOW, true, "galUr");
RelayComponent galleryDownRelay (32, LOW, true, "galDr");

// height motion
MotionRangeComponent galleryHeightMotion (60000, 100, &galleryUpRelay, &galleryDownRelay, NULL, "galHm");

// rotation motion
MotionRangeComponent galleryRotationMotion (windowLouvreShutterRotationMillis, 100, &galleryUpRelay, &galleryDownRelay, NULL, "galRm");

// shutter
ShutterComponent gallery (&galleryHeightMotion, &galleryRotationMotion, &buttonGalleryUp, &buttonGalleryDown, "WlsGallery", reportMillis);

///////////////////
//
// hot water recirculation pump
//
///////////////////
TimedRelayComponent hotWaterRecirculationPump (21, LOW, true, "HWPump", reportMillis);

///////////////////
//
// spare
//
///////////////////
RelayComponent spareRelay1 (23, LOW, true, "spare1");
RelayComponent spareRelay2 (25, LOW, true, "spare2");
RelayComponent spareRelay3 (27, LOW, true, "spare3");
RelayComponent spareRelay4 (29, LOW, true, "spare4");
RelayComponent spareRelay5 (31, LOW, true, "spare5");
RelayComponent spareRelay6 (33, LOW, true, "spare6");

///////////////////
//
// Ethernet
//
///////////////////
#if ENABLE_ETHERNET
byte mac[] =
{ 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED };
IPAddress ip (192, 168, 1, 50);
EthernetW5100Component ethernetServer (mac, &ip, 5555, "eth");
#endif

///////////////////
//
// Serial
//
///////////////////
#if ENABLE_SERIAL
HardwareSerialComponent serial (&Serial, "serial");
#endif

///////////////////
//
// Message
//
///////////////////
#define MESSAGE_BUFFER_SIZE 512

char inboundMessageBuffer[MESSAGE_BUFFER_SIZE];
Message inboundMessage (inboundMessageBuffer, MESSAGE_BUFFER_SIZE);

char outboundMessageBuffer[MESSAGE_BUFFER_SIZE];
Message outboundMessage (outboundMessageBuffer, MESSAGE_BUFFER_SIZE);

///////////////////
//
// Components
//
///////////////////
Component* components[] =
{ &kitchenEast, &kitchenSouth, &livingroomWest, &livingroomSouth, &diningRoom, &bathroom, &staircase, &bathroom1, &kidsRoomEast, &kidsRoomSouth, &gallery, &bedroom, &hotWaterRecirculationPump,
    &spareRelay1, &spareRelay2, &spareRelay3, &spareRelay4, &spareRelay5, NULL };

Component* commandComponents[] =
{
#if ENABLE_ETHERNET
    &ethernetServer,
#endif

#if ENABLE_SERIAL
    &serial,
#endif
    NULL };

///////////////////
//
// Shell
//
///////////////////
Shell shell (components, commandComponents, &inboundMessage, &outboundMessage, 10, "shell");

///////////////////
//
// Main
//
///////////////////
void setup ()
{
#if ENABLE_SERIAL
    Serial.begin (115200);
    Serial.setTimeout (5000);
#endif
    shell.setup ();
}

void loop ()
{
//    pinMode (52, OUTPUT);
//    delay (1500);
//    digitalWrite (52, HIGH);
//    delay (1500);
//    digitalWrite (52, LOW);
    shell.loop ();
}
